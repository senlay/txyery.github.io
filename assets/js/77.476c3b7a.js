(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{568:function(s,n,e){"use strict";e.r(n);var a=e(4),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h3",{attrs:{id:"使用场景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用场景"}},[s._v("#")]),s._v(" 使用场景")]),s._v(" "),e("blockquote",[e("p",[s._v("当业务并发操作较多，需要按顺序处理数据，如库存更新。")])]),s._v(" "),e("h4",{attrs:{id:"使用方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用方式"}},[s._v("#")]),s._v(" 使用方式")]),s._v(" "),e("ul",[e("li",[s._v("1、等待式")])]),s._v(" "),e("blockquote",[e("p",[s._v("调用方指定最大等待时间，内部会不断进行重试，保证业务可以按照顺序执行\nLockUtils.excute4Wait(String key,int waitSeconds, LockBusi lockBusi);")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/**\n    * 需要等待，发现没有锁成功，等待时间内不断重试,超过等待时间，抛出错误，自动解锁\n    * @param key\n    * @param waitSeconds\n    * @param lockBusi\n    */\n   public static void excute4Wait(String key,int waitSeconds, LockBusi lockBusi) throws SysAppException {\n \n       try {\n           boolean isLock = RedisUtils.lock(key, key);\n           int times = 0;\n           int maxTimes = waitSeconds * 1000 / INTERVAL_TIME;\n           while (!isLock){\n               SysAppException.publish(times >= maxTimes,SysErrCode.ERR_BUSI_LOCK_TIMEOUT );\n               Thread.sleep(INTERVAL_TIME);\n               times++;\n               isLock = RedisUtils.lock(key, key);\n           }\n \n           lockBusi.callback();\n       }catch (SysAppException e){\n           throw e;\n       }catch (Exception e){\n           throw new SysAppException(SysErrCode.UNKNOW_EXPCEPTION, e);\n       }finally {\n           RedisUtils.unLock(key, key);\n       }\n   }\n\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br")])]),e("ul",[e("li",[s._v("2、阻断式")])]),s._v(" "),e("blockquote",[e("p",[s._v("当触发加锁失败后，直接抛出异常。\nLockUtils.excute(String key,LockBusi lockBusi);")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\n    /**\n    * 无需等待，发现没有锁成功，直接返回失败\n    * @param key\n    * @param lockBusi\n    */\n   public static void excute(String key, LockBusi lockBusi) throws SysAppException {\n       boolean isLock = RedisUtils.lock(key, key);\n       SysAppException.publish(!isLock, ErrCode.REDIS_LOCK_FAIL);\n       try {\n           lockBusi.callback();\n       }catch (SysAppException e){\n           throw e;\n       }catch (Exception e){\n           throw new SysAppException(SysErrCode.UNKNOW_EXPCEPTION, e);\n       }finally {\n           RedisUtils.unLock(key, key);\n       }\n   }\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("ul",[e("li",[s._v("如何使用")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('\n   String busikey = NO_PREFIX + vo.getReqNo() + vo.getFlowBatchNo();\n   String busikeyValue = vo.getReqNo() + vo.getFlowBatchNo();\n   boolean isLock = RedisUtils.lock(busikey, busikeyValue, "60");\n   SysAppException.publishMsg(!isLock, "请勿重复操作");\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("ul",[e("li",[s._v("RedisUtils实现")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\npublic final class RedisUtils<T> {\n    private static final String newSetIfAbsentScriptStr = \" if 1 == redis.call('setnx',KEYS[1],ARGV[1]) then redis.call('expire',KEYS[1],ARGV[2]) return 1; else return 0; end;\";\n    private static RedisScript<Boolean> newSetIfAbsentScript = new DefaultRedisScript(\" if 1 == redis.call('setnx',KEYS[1],ARGV[1]) then redis.call('expire',KEYS[1],ARGV[2]) return 1; else return 0; end;\", Boolean.class);\n    private static final String LOCK_EXPIRE_TIME = \"3\";\n    private static StringRedisTemplate TEMPLATE;\n    @Autowired\n    private StringRedisTemplate redisTemplate;\n\n    private RedisUtils() {\n    }\n\n    @PostConstruct\n    public void init() {\n        TEMPLATE = this.redisTemplate;\n    }\n\n\n    public static Long incrBy(String key, long increment) {\n        return TEMPLATE.opsForValue().increment(key, increment);\n    }\n\n\n    public static boolean lock(String key, String value) throws BaseAppException {\n        return lock(key, value, \"3\");\n    }\n\n  public static boolean lock(String key, String value, String seconds) throws SysAppException {\n        List<String> keys = new ArrayList();\n        keys.add(key);\n        Object[] args = new Object[]{value, seconds};\n        Boolean flag = (Boolean)TEMPLATE.execute(newSetIfAbsentScript, keys, args);\n        return AppUtils.notEmpty(flag) && flag;\n    }\n    \n    \n    public static void unLock(String key, String value) {\n            if (value.equals(TEMPLATE.opsForValue().get(key))) {\n                TEMPLATE.opsForValue().getOperations().delete(key);\n            }\n    \n        }\n    \n    \n    \n  }\n\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);